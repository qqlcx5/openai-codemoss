# VPS 日志查看指南

本文档介绍在VPS上部署后如何查看项目日志的多种方式。

## 方式一：PM2 日志查看（推荐）

如果使用PM2管理进程，这是最方便的日志查看方式。

### 1. 实时查看日志

```bash
# 查看所有日志（实时）
pm2 logs moss-proxy

# 查看最近100行日志
pm2 logs moss-proxy --lines 100

# 只查看错误日志
pm2 logs moss-proxy --err

# 只查看标准输出日志
pm2 logs moss-proxy --out
```

### 2. 查看历史日志文件

PM2默认将日志保存在 `~/.pm2/logs/` 目录：

```bash
# 查看日志文件位置
pm2 describe moss-proxy

# 直接查看日志文件
tail -f ~/.pm2/logs/moss-proxy-out.log    # 标准输出
tail -f ~/.pm2/logs/moss-proxy-error.log # 错误日志

# 查看最近100行
tail -n 100 ~/.pm2/logs/moss-proxy-out.log

# 搜索日志内容
grep "ERROR" ~/.pm2/logs/moss-proxy-out.log
grep "Request completed" ~/.pm2/logs/moss-proxy-out.log
```

### 3. 清空日志

```bash
# 清空所有日志
pm2 flush moss-proxy

# 清空所有PM2应用的日志
pm2 flush
```

### 4. PM2日志配置

创建 `ecosystem.config.js` 文件可以自定义日志路径和大小：

```bash
pm2 ecosystem
```

然后编辑配置文件，设置日志路径和轮转策略。

## 方式二：文件日志查看（推荐用于生产环境）

项目已支持将日志写入文件，日志文件保存在 `logs/` 目录。

### 1. 查看实时日志

```bash
# 查看应用日志（实时）
tail -f logs/app.log

# 查看错误日志（实时）
tail -f logs/error.log

# 查看所有日志文件
ls -lh logs/
```

### 2. 查看历史日志

```bash
# 查看最近100行
tail -n 100 logs/app.log

# 查看完整日志
cat logs/app.log

# 分页查看
less logs/app.log

# 搜索特定内容
grep "ERROR" logs/app.log
grep "Request completed" logs/app.log
grep "401" logs/error.log
```

### 3. 日志文件说明

- `logs/app.log` - 所有应用日志（INFO、WARN、ERROR）
- `logs/error.log` - 仅错误日志（ERROR级别）
- 日志文件会自动按天轮转，格式：`app-2024-01-01.log`

### 4. 日志轮转

日志文件会自动按天轮转，旧日志会保留7天（可在代码中配置）。

手动清理旧日志：

```bash
# 删除7天前的日志
find logs/ -name "*.log" -mtime +7 -delete

# 查看日志文件大小
du -sh logs/
```

## 方式三：systemd 日志查看

如果使用systemd服务管理，可以使用journalctl查看日志。

### 1. 查看实时日志

```bash
# 实时查看服务日志
sudo journalctl -u moss-proxy -f

# 查看最近100行
sudo journalctl -u moss-proxy -n 100

# 查看今天的日志
sudo journalctl -u moss-proxy --since today

# 查看最近1小时的日志
sudo journalctl -u moss-proxy --since "1 hour ago"
```

### 2. 搜索和过滤

```bash
# 搜索包含ERROR的日志
sudo journalctl -u moss-proxy | grep ERROR

# 查看特定时间段的日志
sudo journalctl -u moss-proxy --since "2024-01-01 00:00:00" --until "2024-01-02 00:00:00"

# 只查看错误级别
sudo journalctl -u moss-proxy -p err
```

## 方式四：Docker 日志查看

如果使用Docker部署，使用docker logs命令。

### 1. 查看实时日志

```bash
# 实时查看容器日志
docker logs -f moss-proxy

# 查看最近100行
docker logs --tail 100 moss-proxy

# 查看特定时间段的日志
docker logs --since "2024-01-01T00:00:00" moss-proxy
```

### 2. 导出日志

```bash
# 导出日志到文件
docker logs moss-proxy > logs/docker.log 2>&1
```

## 方式五：直接查看进程输出

如果直接使用 `node server.js` 或 `npm start` 运行：

```bash
# 如果使用nohup运行
tail -f nohup.out

# 如果重定向到文件
tail -f output.log

# 如果使用screen
screen -r moss-proxy

# 如果使用tmux
tmux attach -t moss-proxy
```

## 常用日志查看命令组合

### 1. 实时监控错误

```bash
# PM2方式
pm2 logs moss-proxy --err --lines 50

# 文件日志方式
tail -f logs/error.log | grep --color=always ERROR
```

### 2. 统计请求数量

```bash
# 统计今天的请求数
grep "Request completed" logs/app.log | grep "$(date +%Y-%m-%d)" | wc -l

# 统计错误数量
grep "ERROR" logs/error.log | grep "$(date +%Y-%m-%d)" | wc -l
```

### 3. 查看特定请求ID的日志

```bash
# 查找特定请求ID的所有日志
grep "requestId.*abc-123-def" logs/app.log
```

### 4. 查看API响应时间

```bash
# 查看响应时间超过1秒的请求
grep "Request completed" logs/app.log | grep -E "duration.*[1-9][0-9]{3,}ms"
```

## 日志级别说明

- **INFO**: 一般信息，如请求完成、会话创建等
- **WARN**: 警告信息，如缺少Token、API错误等
- **ERROR**: 错误信息，包含完整的错误堆栈

## 日志格式说明

日志格式：`[时间戳] [级别] 消息内容 [元数据JSON]`

示例：
```
[2024-01-01T12:00:00.000Z] [INFO] Request completed {"id":"abc-123","method":"POST","url":"/v1/chat/completions","status":200,"duration":"150ms"}
```

## 故障排查示例

### 查看服务是否正常运行

```bash
# PM2方式
pm2 status moss-proxy
pm2 logs moss-proxy --lines 20

# 文件日志方式
tail -n 50 logs/app.log
```

### 查看最近的错误

```bash
# 查看最近10条错误
tail -n 100 logs/error.log | grep ERROR | tail -n 10

# 或使用PM2
pm2 logs moss-proxy --err --lines 10
```

### 查看API调用情况

```bash
# 查看最近的API请求
grep "Request completed" logs/app.log | tail -n 20

# 查看失败的请求
grep "status.*[45][0-9][0-9]" logs/app.log
```

## 注意事项

1. **日志文件大小**: 定期清理旧日志，避免磁盘空间不足
2. **日志权限**: 确保日志目录有写入权限
3. **日志轮转**: 生产环境建议配置日志轮转，避免单个文件过大
4. **敏感信息**: 日志中可能包含Token等敏感信息，注意保护日志文件权限

## 快速参考

```bash
# PM2 - 实时日志
pm2 logs moss-proxy

# 文件日志 - 实时查看
tail -f logs/app.log

# systemd - 实时日志
sudo journalctl -u moss-proxy -f

# Docker - 实时日志
docker logs -f moss-proxy

# 查看错误日志
tail -f logs/error.log

# 搜索日志
grep "关键词" logs/app.log
```
